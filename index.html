<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempest Weather Display</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #87cefa;
            color: #2c3e50;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .frame {
            background: linear-gradient(145deg, rgba(230, 230, 224, 0.7), rgba(255, 255, 255, 0.7));
            padding: 20px;
            border-radius: 12px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            width: 95vw;
            height: 95vh;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
        }

        .display {
            background: rgba(255, 255, 255, 0.10);
            padding: 20px;
            border-radius: 4px;
            border: 1px solid rgba(224, 224, 220, 0.1);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0dc;
            position: relative;
            flex-shrink: 0;
        }

        .date-time {
            font-size: 0.95em;
            color: #666;
        }

        .last-update {
            font-size: 0.75em;
            color: #999;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            color: #3498db;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: rotate(90deg);
        }

        .main-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            flex: 0 0 auto;
            min-height: 50vh;
        }

        .current-weather {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .weather-icon {
            font-size: 134px;
            line-height: 1;
        }

        .temperature-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .temp-large {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 6.72em;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1;
            color: #2c3e50;
        }

        .temp-unit {
            font-size: 3.36em;
            font-weight: 300;
            color: #7f8c8d;
        }

        .feels-like {
            font-size: 1.76em;
            font-weight: 600;
            color: #5a6c7d;
            margin-top: 5px;
        }

        .high-low {
            font-size: 2.1em;
            font-weight: 600;
            color: #4a5568;
            margin-top: 5px;
        }

        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            justify-items: center;
        }

        .condition-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
        }

        .condition-icon {
            font-size: 1.8em;
            color: #95a5a6;
        }

        .condition-label {
            font-size: 0.9em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .condition-value {
            font-size: 1.56em;
            font-weight: 500;
            color: #2c3e50;
        }

        .condition-unit {
            font-size: 1.02em;
            color: #7f8c8d;
        }

        .hourly-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0dc;
            flex-shrink: 0;
        }

        .hourly-title {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .hourly-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 #ecf0f1;
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: #ecf0f1;
            border-radius: 3px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        .hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 60px;
        }

        .hour-time {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .hour-icon {
            font-size: 1.8em;
        }

        .hour-temp {
            font-size: 1em;
            font-weight: 500;
            color: #2c3e50;
        }

        .forecast-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0dc;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .forecast-title {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .forecast-days {
            display: flex;
            gap: 10px;
            width: 100%;
            flex: 1;
            align-items: stretch;
            padding-bottom: 10px;
        }

        .day-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            padding: 10px;
            background: #f5f5f0;
            border-radius: 4px;
        }

        .day-name {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 500;
        }

        .day-icon {
            font-size: 2em;
        }

        .day-temps {
            font-size: 0.9em;
            color: #2c3e50;
        }

        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .setup-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .setup-card h2 {
            margin-bottom: 25px;
            color: #2c3e50;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0dc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 0.85em;
        }

        .form-group small a {
            color: #3498db;
        }

        button {
            width: 100%;
            background: #3498db;
            color: white;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .btn-secondary {
            background: #95a5a6 !important;
        }

        .btn-secondary:hover {
            background: #7f8c8d !important;
        }

        .btn-danger {
            background: #e74c3c !important;
        }

        .btn-danger:hover {
            background: #c0392b !important;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /* Landscape tablets and smaller desktops */
        @media (max-height: 800px) {
            .frame {
                padding: 10px;
            }

            .display {
                padding: 15px;
            }

            .header {
                margin-bottom: 10px;
                padding-bottom: 8px;
            }

            .main-section {
                gap: 15px;
                margin-bottom: 10px;
            }

            .weather-icon {
                font-size: 101px;  /* 72px * 1.4 */
            }

            .temp-large {
                font-size: 5.04em;  /* 3.6em * 1.4 */
            }

            .conditions-grid {
                gap: 8px;
            }

            .condition-item {
                gap: 3px;
            }

            .condition-icon {
                font-size: 1.44em;  /* 1.2em * 1.2 */
            }

            .condition-label {
                font-size: 0.84em;  /* 0.7em * 1.2 */
            }

            .condition-value {
                font-size: 1.32em;  /* 1.1em * 1.2 */
            }

            .hourly-section {
                margin-top: 10px;
                padding-top: 10px;
            }

            .hourly-title {
                margin-bottom: 8px;
                font-size: 0.75em;
            }

            .hour-item {
                gap: 5px;
                min-width: 50px;
            }

            .hour-time {
                font-size: 0.7em;
            }

            .hour-icon {
                font-size: 1.5em;
            }

            .hour-temp {
                font-size: 0.9em;
            }

            .forecast-section {
                margin-top: 10px;
                padding-top: 10px;
                flex: 0.6 1 auto;
            }

            .forecast-title {
                margin-bottom: 8px;
                font-size: 0.75em;
            }

            .day-item {
                padding: 8px;
                gap: 5px;
            }

            .feels-like {
                font-size: 0.95em;
            }

            .high-low {
                font-size: 1.1em;
            }
        }

        /* Very compact for short screens (landscape phones, small tablets) */
        @media (max-height: 600px) {
            .frame {
                padding: 5px;
            }

            .display {
                padding: 10px;
            }

            .header {
                margin-bottom: 5px;
                padding-bottom: 5px;
            }

            .date-time {
                font-size: 0.8em;
            }

            .last-update {
                font-size: 0.65em;
            }

            .settings-btn {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }

            .main-section {
                gap: 10px;
                margin-bottom: 8px;
            }

            .weather-icon {
                font-size: 84px;  /* 60px * 1.4 */
            }

            .temp-large {
                font-size: 4.2em;  /* 3em * 1.4 */
            }

            .temp-unit {
                font-size: 2.52em;  /* 1.8em * 1.4 */
            }

            .feels-like {
                font-size: 1.34em;  /* 0.96em * 1.4 */
                margin-top: 3px;
            }

            .high-low {
                font-size: 1.51em;  /* 1.08em * 1.4 */
                margin-top: 3px;
            }

            .conditions-grid {
                gap: 6px;
            }

            .condition-item {
                gap: 2px;
            }

            .condition-icon {
                font-size: 1.2em;  /* 1em * 1.2 */
            }

            .condition-label {
                font-size: 0.78em;  /* 0.65em * 1.2 */
            }

            .condition-value {
                font-size: 1.14em;  /* 0.95em * 1.2 */
            }

            .hourly-section {
                margin-top: 8px;
                padding-top: 8px;
            }

            .hourly-title {
                margin-bottom: 5px;
                font-size: 0.7em;
            }

            .hour-item {
                gap: 3px;
                min-width: 45px;
            }

            .hour-time {
                font-size: 0.65em;
            }

            .hour-icon {
                font-size: 1.3em;
            }

            .hour-temp {
                font-size: 0.8em;
            }

            .forecast-section {
                margin-top: 8px;
                padding-top: 8px;
                flex: 0.4 1 auto;
            }

            .forecast-title {
                margin-bottom: 5px;
                font-size: 0.7em;
            }

            .day-item {
                padding: 5px;
                gap: 3px;
            }
        }

        /* Landscape orientation optimization */
        @media (orientation: landscape) and (max-height: 900px) {
            .current-weather {
                gap: 15px;
            }
            
            .hourly-scroll {
                gap: 10px;
                padding-bottom: 5px;
            }
            
            .forecast-days {
                gap: 8px;
            }
            
            /* Limit forecast section growth in landscape */
            .forecast-section {
                flex: 0.5;
                min-height: 100px;
            }
            
            /* Give more space to main data section */
            .main-section {
                flex-shrink: 0;
            }
            
            .hourly-section {
                flex-shrink: 0;
            }
        }

        /* Even more constrained for very short landscape screens */
        @media (orientation: landscape) and (max-height: 700px) {
            .forecast-section {
                flex: 0.3;
                min-height: 80px;
            }
            
            /* Make forecast items even more compact */
            .day-item {
                padding: 4px;
            }
        }

        @media (max-width: 768px) {
            .main-section {
                grid-template-columns: 1fr;
            }

            .frame {
                padding: 20px;
            }

            .display {
                padding: 20px;
            }

            .temp-large {
                font-size: 5.04em;  /* 3.6em * 1.4 */
            }
        }
    </style>
</head>

<meta name="theme-color" content="#2c3e50">
<body>
    <div id="setupSection" class="setup-overlay">
        <div class="setup-card">
            <button class="close-btn hidden" id="closeSetupBtn" onclick="closeSettings()">√ó</button>
            <h2 id="setupTitle">‚öôÔ∏è Setup Your Station</h2>
            <div class="form-group">
                <label for="apiToken">API Token:</label>
                <input type="password" id="apiToken" placeholder="Enter your Tempest API token">
                <small>Get your token from <a href="https://tempestwx.com/settings/tokens" target="_blank">tempestwx.com/settings/tokens</a></small>
            </div>
            <div class="form-group">
                <label for="stationId">Station ID:</label>
                <input type="number" id="stationId" placeholder="Enter your station ID">
                <small>Find your station ID in the Tempest app or website</small>
            </div>
            <div class="form-group">
                <label for="tempUnit">Temperature Unit:</label>
                <select id="tempUnit" style="width: 100%; padding: 12px; border: 2px solid #e0e0dc; border-radius: 6px; font-size: 1em;">
                    <option value="F">Fahrenheit (¬∞F)</option>
                    <option value="C">Celsius (¬∞C)</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="keepScreenOn" checked>
                <label for="keepScreenOn">Keep screen on while app is running</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showHourly" checked>
                <label for="showHourly">Show hourly forecast</label>
            </div>
            <div class="form-group">
                <label for="forecastDays">Daily Forecast Days:</label>
                <select id="forecastDays" style="width: 100%; padding: 12px; border: 2px solid #e0e0dc; border-radius: 6px; font-size: 1em;">
                    <option value="5">5 Days</option>
                    <option value="7" selected>7 Days</option>
                    <option value="10">10 Days</option>
                </select>
            </div>
            <button onclick="connectStation()">Save & Connect</button>
            <div class="button-group hidden" id="settingsButtons">
                <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn-danger" onclick="clearData()">Clear Data</button>
            </div>
            <div id="setupError" class="error hidden"></div>
            <div id="setupSuccess" class="success hidden"></div>
        </div>
    </div>

    <div id="weatherSection" class="frame hidden">
        <div class="display">
            <div class="header">
                <div class="date-time" id="dateTime">Loading...</div>
                <div class="last-update" id="lastUpdate">Last update: --</div>
                <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
            </div>

            <div class="main-section">
                <div class="current-weather">
                    <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                    <div class="temperature-main">
                        <div>
                            <span class="temp-large" id="temperature">--</span>
                            <span class="temp-unit">¬∞F</span>
                        </div>
                        <div class="feels-like">Feels Like <span id="feelsLike">--</span>¬∞</div>
                        <div class="high-low"><span id="highLow">26¬∞ / 16¬∞</span></div>
                    </div>
                </div>

                <div class="conditions-grid">
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è‚Üë</div>
                        <div class="condition-label">Sunrise</div>
                        <div class="condition-value">
                            <span id="sunrise">7:36</span><span class="condition-unit">AM</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è‚Üì</div>
                        <div class="condition-label">Sunset</div>
                        <div class="condition-value">
                            <span id="sunset">6:45</span><span class="condition-unit">PM</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üí®</div>
                        <div class="condition-label">Wind</div>
                        <div class="condition-value">
                            <span id="windSpeed">--</span><span class="condition-unit">mph</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üíß</div>
                        <div class="condition-label">Humidity</div>
                        <div class="condition-value">
                            <span id="humidity">--</span><span class="condition-unit">%</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå°Ô∏è</div>
                        <div class="condition-label">Pressure</div>
                        <div class="condition-value">
                            <span id="pressure">--</span><span class="condition-unit">mb</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è</div>
                        <div class="condition-label">UV Index</div>
                        <div class="condition-value">
                            <span id="uv">--</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå§Ô∏è</div>
                        <div class="condition-label">Visibility</div>
                        <div class="condition-value">
                            <span id="visibility">>24</span><span class="condition-unit">mi</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå´Ô∏è</div>
                        <div class="condition-label">Air Quality</div>
                        <div class="condition-value">
                            <span id="airQuality">132</span><span class="condition-unit">AQI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hourly-section">
                <div class="hourly-title">Hourly Forecast</div>
                <div class="hourly-scroll" id="hourlyForecast">
                    <!-- Hourly items will be inserted here -->
                </div>
            </div>

            <div class="forecast-section">
                <div class="forecast-title" id="forecastTitle">7-Day Forecast</div>
                <div class="forecast-days" id="weeklyForecast">
                    <!-- Daily forecast items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiToken = '';
        let stationId = '';
        let ws = null;
        let stationData = null;
        let tempUnit = 'F';
        let keepScreenOn = true;
        let showHourly = true;
        let forecastDays = 7;
        let wakeLock = null;

        // Wake Lock functions
        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('Wake Lock API not supported by this browser.');
                return;
            }
            
            // Don't try to request wake lock if already active
            if (wakeLock !== null) {
                return;
            }
            
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Screen Wake Lock is active!');
                
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock was released');
                    wakeLock = null;
                });
            } catch (err) {
                // Silently handle permission errors - wake lock may not be available
                if (err.name === 'NotAllowedError') {
                    console.log('Wake Lock not allowed - this is normal in some browsers or contexts');
                } else {
                    console.error(`Wake Lock error: ${err.name}, ${err.message}`);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released manually');
            }
        }

        // Re-request wake lock when page becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && keepScreenOn) {
                await requestWakeLock();
            }
        });

        // Load saved credentials
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('tempest_token');
            const savedStation = localStorage.getItem('tempest_station');
            tempUnit = localStorage.getItem('tempest_temp_unit') || 'F';
            keepScreenOn = localStorage.getItem('tempest_keep_screen_on') !== 'false';
            showHourly = localStorage.getItem('tempest_show_hourly') !== 'false';
            forecastDays = parseInt(localStorage.getItem('tempest_forecast_days')) || 7;
            
            if (savedToken && savedStation) {
                document.getElementById('apiToken').value = savedToken;
                document.getElementById('stationId').value = savedStation;
                document.getElementById('tempUnit').value = tempUnit;
                document.getElementById('keepScreenOn').checked = keepScreenOn;
                document.getElementById('showHourly').checked = showHourly;
                document.getElementById('forecastDays').value = forecastDays;
                connectStation();
            }

            updateDateTime();
            setInterval(updateDateTime, 60000); // Update every minute
            
            // Apply forecast visibility
            updateForecastVisibility();
            
            // Activate wake lock if enabled
            if (keepScreenOn) {
                requestWakeLock();
            }
        });

        function openSettings() {
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('closeSetupBtn').classList.remove('hidden');
            document.getElementById('settingsButtons').classList.remove('hidden');
            document.getElementById('setupTitle').textContent = '‚öôÔ∏è Settings';
            document.getElementById('setupError').classList.add('hidden');
            document.getElementById('setupSuccess').classList.add('hidden');
        }

        function closeSettings() {
            document.getElementById('setupSection').classList.add('hidden');
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all saved data and disconnect?')) {
                localStorage.clear();
                if (ws) {
                    ws.close();
                }
                location.reload();
            }
        }

        function updateForecastVisibility() {
            const hourlySection = document.querySelector('.hourly-section');
            const forecastSection = document.querySelector('.forecast-section');
            
            if (hourlySection) {
                hourlySection.style.display = showHourly ? 'block' : 'none';
            }
            
            if (forecastSection) {
                forecastSection.style.display = 'block'; // Always show daily forecast
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function connectStation() {
            apiToken = document.getElementById('apiToken').value.trim();
            stationId = document.getElementById('stationId').value.trim();
            tempUnit = document.getElementById('tempUnit').value;
            keepScreenOn = document.getElementById('keepScreenOn').checked;
            showHourly = document.getElementById('showHourly').checked;
            forecastDays = parseInt(document.getElementById('forecastDays').value);

            if (!apiToken || !stationId) {
                showError('Please enter both API token and station ID');
                return;
            }

            localStorage.setItem('tempest_token', apiToken);
            localStorage.setItem('tempest_station', stationId);
            localStorage.setItem('tempest_temp_unit', tempUnit);
            localStorage.setItem('tempest_keep_screen_on', keepScreenOn);
            localStorage.setItem('tempest_show_hourly', showHourly);
            localStorage.setItem('tempest_forecast_days', forecastDays);

            document.getElementById('setupError').classList.add('hidden');
            document.getElementById('setupSuccess').classList.add('hidden');
            
            updateForecastVisibility();
            fetchStationData();
        }

        async function fetchStationData() {
            try {
                // Fetch station metadata for location
                const stationResponse = await fetch(
                    `https://swd.weatherflow.com/swd/rest/stations/${stationId}?token=${apiToken}`
                );

                if (!stationResponse.ok) {
                    throw new Error('Failed to fetch station data. Check your credentials.');
                }

                stationData = await stationResponse.json();

                // Fetch current observations
                const obsResponse = await fetch(
                    `https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${apiToken}`
                );

                if (!obsResponse.ok) {
                    throw new Error('Failed to fetch observations.');
                }

                const obsData = await obsResponse.json();
                
                if (obsData.obs && obsData.obs.length > 0) {
                    updateDisplay(obsData.obs[0]);
                    
                    // Show success message if settings were open
                    if (!document.getElementById('setupSection').classList.contains('hidden')) {
                        document.getElementById('setupSuccess').textContent = 'Settings saved successfully!';
                        document.getElementById('setupSuccess').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('setupSection').classList.add('hidden');
                        }, 1500);
                    } else {
                        document.getElementById('setupSection').classList.add('hidden');
                    }
                    
                    document.getElementById('weatherSection').classList.remove('hidden');
                    
                    // Fetch current observations first
                    fetchCurrentObservations();
                    
                    // Fetch forecast data
                    fetchForecast();
                    
                    // Refresh observations every 5 minutes
                    setInterval(fetchCurrentObservations, 5 * 60 * 1000);
                    
                    // Refresh forecast every 30 minutes
                    setInterval(fetchForecast, 30 * 60 * 1000);
                    
                    // Handle wake lock based on setting
                    if (keepScreenOn) {
                        requestWakeLock();
                    } else {
                        releaseWakeLock();
                    }
                    
                    // Connect WebSocket
                    connectWebSocket();
                }
            } catch (error) {
                showError(error.message);
            }
        }

        async function fetchCurrentObservations() {
            if (!stationId || !apiToken) return;

            try {
                const response = await fetch(
                    `https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${apiToken}`
                );

                if (!response.ok) {
                    console.error('Failed to fetch current observations');
                    return;
                }

                const data = await response.json();
                if (data.obs && data.obs.length > 0) {
                    updateDisplay(data.obs[0]);
                }
            } catch (error) {
                console.error('Error fetching current observations:', error);
            }
        }

        async function fetchForecast() {
            if (!stationData || !stationData.stations || stationData.stations.length === 0) return;

            const station = stationData.stations[0];
            const lat = station.latitude;
            const lon = station.longitude;

            try {
                const response = await fetch(
                    `https://swd.weatherflow.com/swd/rest/better_forecast?station_id=${stationId}&token=${apiToken}`
                );

                if (!response.ok) return;

                const forecast = await response.json();
                updateForecast(forecast);
            } catch (error) {
                console.error('Error fetching forecast:', error);
            }
        }

        function updateForecast(forecast) {
            if (!forecast || !forecast.forecast || !forecast.forecast.daily) return;

            const daily = forecast.forecast.daily;
            const hourly = forecast.forecast.hourly;

            // Update hourly forecast
            const hourlyContainer = document.getElementById('hourlyForecast');
            hourlyContainer.innerHTML = '';
            
            for (let i = 0; i < Math.min(12, hourly.length); i++) {
                const hour = hourly[i];
                const time = new Date(hour.time * 1000);
                const hourItem = document.createElement('div');
                hourItem.className = 'hour-item';
                hourItem.innerHTML = `
                    <div class="hour-time">${time.getHours() === 0 ? '12 AM' : time.getHours() > 12 ? (time.getHours() - 12) + ' PM' : time.getHours() + ' AM'}</div>
                    <div class="hour-icon">${getWeatherIcon(hour.icon)}</div>
                    <div class="hour-temp">${Math.round(parseFloat(convertTemp(hour.air_temperature)))}¬∞</div>
                `;
                hourlyContainer.appendChild(hourItem);
            }

            // Update daily forecast
            const weeklyContainer = document.getElementById('weeklyForecast');
            weeklyContainer.innerHTML = '';
            
            // Update forecast title
            document.getElementById('forecastTitle').textContent = `${forecastDays}-Day Forecast`;
            
            // Determine sizing based on number of days
            let iconSize, nameSize, tempSize;
            if (forecastDays === 5) {
                iconSize = '2.975em';  // 3.5em * 0.85 = 2.975em
                nameSize = '1em';
                tempSize = '1.1em';
            } else if (forecastDays === 7) {
                iconSize = '2.125em';  // 2.5em * 0.85 = 2.125em
                nameSize = '0.85em';
                tempSize = '0.9em';
            } else { // 10 days
                iconSize = '1.7em';    // 2em * 0.85 = 1.7em
                nameSize = '0.75em';
                tempSize = '0.8em';
            }
            
            for (let i = 0; i < Math.min(forecastDays, daily.length); i++) {
                const day = daily[i];
                const date = new Date(day.day_start_local * 1000);
                const dayItem = document.createElement('div');
                dayItem.className = 'day-item';
                dayItem.innerHTML = `
                    <div class="day-name" style="font-size: ${nameSize}">${i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    <div class="day-icon" style="font-size: ${iconSize}">${getWeatherIcon(day.icon)}</div>
                    <div class="day-temps" style="font-size: ${tempSize}">${Math.round(parseFloat(convertTemp(day.air_temp_high)))}¬∞ / ${Math.round(parseFloat(convertTemp(day.air_temp_low)))}¬∞</div>
                `;
                weeklyContainer.appendChild(dayItem);
            }

            // Update sunrise/sunset
            if (daily[0]) {
                const sunrise = new Date(daily[0].sunrise * 1000);
                const sunset = new Date(daily[0].sunset * 1000);
                
                // Format sunrise
                const sunriseHours = sunrise.getHours();
                const sunriseMinutes = sunrise.getMinutes().toString().padStart(2, '0');
                const sunriseAmPm = sunriseHours >= 12 ? 'PM' : 'AM';
                const sunriseDisplay = ((sunriseHours + 11) % 12 + 1) + ':' + sunriseMinutes;
                
                // Format sunset
                const sunsetHours = sunset.getHours();
                const sunsetMinutes = sunset.getMinutes().toString().padStart(2, '0');
                const sunsetAmPm = sunsetHours >= 12 ? 'PM' : 'AM';
                const sunsetDisplay = ((sunsetHours + 11) % 12 + 1) + ':' + sunsetMinutes;
                
                document.getElementById('sunrise').textContent = sunriseDisplay;
                document.getElementById('sunset').textContent = sunsetDisplay;
            }
        }

        function getWeatherIcon(iconName) {
            const icons = {
                'clear-day': '‚òÄÔ∏è',
                'clear-night': 'üåô',
                'cloudy': '‚òÅÔ∏è',
                'foggy': 'üå´Ô∏è',
                'partly-cloudy-day': '‚õÖ',
                'partly-cloudy-night': '‚òÅÔ∏è',
                'possibly-rainy-day': 'üå¶Ô∏è',
                'possibly-rainy-night': 'üåßÔ∏è',
                'possibly-sleet-day': 'üå®Ô∏è',
                'possibly-sleet-night': 'üå®Ô∏è',
                'possibly-snow-day': 'üå®Ô∏è',
                'possibly-snow-night': 'üå®Ô∏è',
                'possibly-thunderstorm-day': '‚õàÔ∏è',
                'possibly-thunderstorm-night': '‚õàÔ∏è',
                'rainy': 'üåßÔ∏è',
                'sleet': 'üå®Ô∏è',
                'snow': '‚ùÑÔ∏è',
                'thunderstorm': '‚õàÔ∏è',
                'windy': 'üí®'
            };
            return icons[iconName] || 'üå§Ô∏è';
        }

        function connectWebSocket() {
            if (ws) ws.close();

            ws = new WebSocket('wss://ws.weatherflow.com/swd/data?token=' + apiToken);

            ws.onopen = () => {
                console.log('WebSocket connected');
                ws.send(JSON.stringify({
                    type: 'listen_start',
                    station_id: parseInt(stationId),
                    id: 'station-' + stationId
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'obs_st') {
                    updateDisplayFromWebSocket(data.obs[0]);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        function convertTemp(tempC) {
            if (tempUnit === 'C') {
                return tempC.toFixed(1);
            }
            return (tempC * 9/5 + 32).toFixed(1);
        }

        function getTempUnit() {
            return tempUnit === 'C' ? '¬∞C' : '¬∞F';
        }

        function updateDisplay(obs) {
            const temp = convertTemp(obs.air_temperature);
            const feelsLike = obs.feels_like ? convertTemp(obs.feels_like) : temp;
            
            document.getElementById('temperature').textContent = Math.round(parseFloat(temp));
            document.getElementById('feelsLike').textContent = Math.round(parseFloat(feelsLike));
            
            // Update the temperature unit display
            document.querySelectorAll('.temp-unit').forEach(el => {
                el.textContent = getTempUnit();
            });
            
            document.getElementById('humidity').textContent = Math.round(obs.relative_humidity);
            document.getElementById('windSpeed').textContent = (obs.wind_avg * 2.237).toFixed(1);
            document.getElementById('pressure').textContent = Math.round(obs.barometric_pressure);
            document.getElementById('uv').textContent = obs.uv.toFixed(1);
            
            // Update weather icon based on conditions
            updateWeatherIcon(obs);
            updateLastUpdateTime();
        }

        function updateDisplayFromWebSocket(obs) {
            // obs array indices from Tempest API:
            // [0] timestamp, [1] wind_lull, [2] wind_avg, [3] wind_gust, [4] wind_direction
            // [5] wind_sample_interval, [6] pressure, [7] air_temp, [8] relative_humidity
            // [9] illuminance, [10] uv, [11] solar_radiation, [12] rain_accumulated
            // [13] precip_type, [14] avg_strike_distance, [15] strike_count, [16] battery
            // [17] report_interval
            
            const tempC = obs[7];
            const humidity = obs[8];
            const windSpeedMs = obs[2];
            
            const temp = convertTemp(tempC);
            
            // Calculate feels-like (simple approximation using wind chill and heat index)
            let feelsLikeC = tempC;
            if (tempC < 10 && windSpeedMs > 1.34) {
                // Wind chill formula (metric)
                const windSpeedKmh = windSpeedMs * 3.6;
                feelsLikeC = 13.12 + 0.6215 * tempC - 11.37 * Math.pow(windSpeedKmh, 0.16) + 0.3965 * tempC * Math.pow(windSpeedKmh, 0.16);
            } else if (tempC > 27 && humidity > 40) {
                // Heat index approximation
                const tempF = tempC * 9/5 + 32;
                let hiF = -42.379 + 2.04901523 * tempF + 10.14333127 * humidity - 0.22475541 * tempF * humidity;
                hiF += -0.00683783 * tempF * tempF - 0.05481717 * humidity * humidity;
                hiF += 0.00122874 * tempF * tempF * humidity + 0.00085282 * tempF * humidity * humidity;
                hiF += -0.00000199 * tempF * tempF * humidity * humidity;
                feelsLikeC = (hiF - 32) * 5/9;
            }
            
            const feelsLike = convertTemp(feelsLikeC);
            
            document.getElementById('temperature').textContent = Math.round(parseFloat(temp));
            document.getElementById('feelsLike').textContent = Math.round(parseFloat(feelsLike));
            document.getElementById('humidity').textContent = Math.round(humidity);
            document.getElementById('windSpeed').textContent = (windSpeedMs * 2.237).toFixed(1);
            document.getElementById('pressure').textContent = Math.round(obs[6]);
            document.getElementById('uv').textContent = obs[10].toFixed(1);
            
            // Update weather icon based on conditions
            const obsObj = {
                precip_type: obs[13],
                solar_radiation: obs[11]
            };
            updateWeatherIcon(obsObj);
            
            updateLastUpdateTime();
        }

        function updateWeatherIcon(obs) {
            let icon = 'üå§Ô∏è';
            
            if (obs.precip_type > 0) {
                icon = 'üåßÔ∏è';
            } else if (obs.solar_radiation > 800) {
                icon = '‚òÄÔ∏è';
            } else if (obs.solar_radiation > 400) {
                icon = '‚õÖ';
            } else if (obs.solar_radiation > 100) {
                icon = '‚òÅÔ∏è';
            } else {
                icon = 'üåô';
            }
            
            document.getElementById('weatherIcon').textContent = icon;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('setupError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        // Register the Service Worker for PWA functionality (only when hosted properly)
        if ('serviceWorker' in navigator && location.protocol === 'https:' && !location.hostname.includes('claudeusercontent')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!'))
                    .catch(err => console.log('Service Worker not available - app will work without offline support'));
            });
        }
    </script>
</body>
</html>
