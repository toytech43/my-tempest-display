<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempest Weather Display</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f0;
            color: #2c3e50;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .frame {
            background: linear-gradient(145deg, #e6e6e0, #ffffff);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            max-width: 900px;
            width: 100%;
        }

        .display {
            background: #fafaf8;
            padding: 30px;
            border-radius: 4px;
            border: 1px solid #e0e0dc;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0dc;
            position: relative;
        }

        .date-time {
            font-size: 0.95em;
            color: #666;
        }

        .last-update {
            font-size: 0.75em;
            color: #999;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            color: #3498db;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: rotate(90deg);
        }

        .main-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 25px;
        }

        .current-weather {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .weather-icon {
            font-size: 100px;
            line-height: 1;
        }

        .temperature-main {
            display: flex;
            flex-direction: column;
        }

        .temp-large {
            font-size: 4em;
            font-weight: 300;
            line-height: 1;
            color: #2c3e50;
        }

        .temp-unit {
            font-size: 2em;
            font-weight: 300;
            color: #7f8c8d;
        }

        .feels-like {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .high-low {
            font-size: 1.1em;
            color: #666;
            margin-top: 5px;
        }

        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .condition-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .condition-icon {
            font-size: 1.5em;
            color: #95a5a6;
        }

        .condition-label {
            font-size: 0.75em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .condition-value {
            font-size: 1.3em;
            font-weight: 500;
            color: #2c3e50;
        }

        .condition-unit {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .hourly-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0dc;
        }

        .hourly-title {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .hourly-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #bdc3c7 #ecf0f1;
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: #ecf0f1;
            border-radius: 3px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        .hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 60px;
        }

        .hour-time {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .hour-icon {
            font-size: 1.8em;
        }

        .hour-temp {
            font-size: 1em;
            font-weight: 500;
            color: #2c3e50;
        }

        .forecast-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0dc;
        }

        .forecast-title {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .forecast-days {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .day-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 80px;
            padding: 10px;
            background: #f5f5f0;
            border-radius: 4px;
        }

        .day-name {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 500;
        }

        .day-icon {
            font-size: 2em;
        }

        .day-temps {
            font-size: 0.9em;
            color: #2c3e50;
        }

        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .setup-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .setup-card h2 {
            margin-bottom: 25px;
            color: #2c3e50;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0dc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 0.85em;
        }

        .form-group small a {
            color: #3498db;
        }

        button {
            width: 100%;
            background: #3498db;
            color: white;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .btn-secondary {
            background: #95a5a6 !important;
        }

        .btn-secondary:hover {
            background: #7f8c8d !important;
        }

        .btn-danger {
            background: #e74c3c !important;
        }

        .btn-danger:hover {
            background: #c0392b !important;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .main-section {
                grid-template-columns: 1fr;
            }

            .frame {
                padding: 20px;
            }

            .display {
                padding: 20px;
            }

            .temp-large {
                font-size: 3em;
            }
            let wakeLock = null;

// Function to request the screen stay on
async function requestWakeLock() {
    if (!('wakeLock' in navigator)) {
        console.log('Wake Lock API not supported by this browser.');
        return;
    }
    
    try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Screen Wake Lock is active!');
        
        // If the app is minimized and then reopened, re-request the lock
        wakeLock.addEventListener('release', () => {
            console.log('Wake Lock was released');
        });
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
    }
}

// Check the setting and activate if enabled
function handleWakeLock() {
    const shouldKeepOn = document.getElementById('keepScreenOn').checked;
    if (shouldKeepOn) {
        requestWakeLock();
    } else if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
    window.addEventListener('load', () => {
    // ... existing code ...
    if (keepScreenOn) {
        requestWakeLock();
    }
        window.addEventListener('load', () => {
    // ... your existing load code ...
    
    // Refresh the full weather data every 5 minutes
    setInterval(() => {
        fetchStationData();
    }, 300000); // 300,000ms = 5 minutes
});
            // Add this to your load listener to update forecast every hour
setInterval(() => {
    fetchForecast();
}, 3600000); // 1 hour
});
}
        }
    </style>
</head>

<meta name="theme-color" content="#2c3e50">
<body>
    <div id="setupSection" class="setup-overlay">
        <div class="setup-card">
            <button class="close-btn hidden" id="closeSetupBtn" onclick="closeSettings()">√ó</button>
            <h2 id="setupTitle">‚öôÔ∏è Setup Your Station</h2>
            <div class="form-group">
                <label for="apiToken">API Token:</label>
                <input type="password" id="apiToken" placeholder="Enter your Tempest API token">
                <small>Get your token from <a href="https://tempestwx.com/settings/tokens" target="_blank">tempestwx.com/settings/tokens</a></small>
            </div>
            <div class="form-group">
                <label for="stationId">Station ID:</label>
                <input type="number" id="stationId" placeholder="Enter your station ID">
                <small>Find your station ID in the Tempest app or website</small>
            </div>
            <div class="form-group">
                <label for="tempUnit">Temperature Unit:</label>
                <select id="tempUnit" style="width: 100%; padding: 12px; border: 2px solid #e0e0dc; border-radius: 6px; font-size: 1em;">
                    <option value="F">Fahrenheit (¬∞F)</option>
                    <option value="C">Celsius (¬∞C)</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="keepScreenOn" checked>
                <label for="keepScreenOn">Keep screen on while app is running</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showForecast" checked>
                <label for="showForecast">Show hourly and daily forecast</label>
            </div>
            <button onclick="connectStation()">Save & Connect</button>
            <div class="button-group hidden" id="settingsButtons">
                <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn-danger" onclick="clearData()">Clear Data</button>
            </div>
            <div id="setupError" class="error hidden"></div>
            <div id="setupSuccess" class="success hidden"></div>
        </div>
    </div>

    <div id="weatherSection" class="frame hidden">
        <div class="display">
            <div class="header">
                <div class="date-time" id="dateTime">Loading...</div>
                <div class="last-update" id="lastUpdate">Last update: --</div>
                <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
            </div>

            <div class="main-section">
                <div class="current-weather">
                    <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                    <div class="temperature-main">
                        <div>
                            <span class="temp-large" id="temperature">--</span>
                            <span class="temp-unit">¬∞F</span>
                        </div>
                        <div class="feels-like">Feels Like <span id="feelsLike">--</span>¬∞</div>
                        <div class="high-low"><span id="highLow">26¬∞ / 16¬∞</span></div>
                    </div>
                </div>

                <div class="conditions-grid">
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è‚Üë</div>
                        <div class="condition-label">Sunrise</div>
                        <div class="condition-value">
                            <span id="sunrise">7:36</span><span class="condition-unit">AM</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è‚Üì</div>
                        <div class="condition-label">Sunset</div>
                        <div class="condition-value">
                            <span id="sunset">6:45</span><span class="condition-unit">PM</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üí®</div>
                        <div class="condition-label">Wind</div>
                        <div class="condition-value">
                            <span id="windSpeed">--</span><span class="condition-unit">mph</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üíß</div>
                        <div class="condition-label">Humidity</div>
                        <div class="condition-value">
                            <span id="humidity">--</span><span class="condition-unit">%</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå°Ô∏è</div>
                        <div class="condition-label">Pressure</div>
                        <div class="condition-value">
                            <span id="pressure">--</span><span class="condition-unit">inHg</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">‚òÄÔ∏è</div>
                        <div class="condition-label">UV Index</div>
                        <div class="condition-value">
                            <span id="uv">--</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå§Ô∏è</div>
                        <div class="condition-label">Visibility</div>
                        <div class="condition-value">
                            <span id="visibility">>24</span><span class="condition-unit">mi</span>
                        </div>
                    </div>
                    <div class="condition-item">
                        <div class="condition-icon">üå´Ô∏è</div>
                        <div class="condition-label">Air Quality</div>
                        <div class="condition-value">
                            <span id="airQuality">132</span><span class="condition-unit">AQI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hourly-section">
                <div class="hourly-title">Hourly Forecast</div>
                <div class="hourly-scroll" id="hourlyForecast">
                    <!-- Hourly items will be inserted here -->
                </div>
            </div>

            <div class="forecast-section">
                <div class="forecast-title">7-Day Forecast</div>
                <div class="forecast-days" id="weeklyForecast">
                    <!-- Daily forecast items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiToken = '';
        let stationId = '';
        let ws = null;
        let stationData = null;
        let tempUnit = 'F';
        let keepScreenOn = true;
        let showForecast = true;

        // Load saved credentials
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('tempest_token');
            const savedStation = localStorage.getItem('tempest_station');
            tempUnit = localStorage.getItem('tempest_temp_unit') || 'F';
            keepScreenOn = localStorage.getItem('tempest_keep_screen_on') !== 'false';
            showForecast = localStorage.getItem('tempest_show_forecast') !== 'false';
            
            if (savedToken && savedStation) {
                document.getElementById('apiToken').value = savedToken;
                document.getElementById('stationId').value = savedStation;
                document.getElementById('tempUnit').value = tempUnit;
                document.getElementById('keepScreenOn').checked = keepScreenOn;
                document.getElementById('showForecast').checked = showForecast;
                connectStation();
            }

            updateDateTime();
            setInterval(updateDateTime, 60000); // Update every minute
            
            // Apply forecast visibility
            updateForecastVisibility();
        });

        function openSettings() {
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('closeSetupBtn').classList.remove('hidden');
            document.getElementById('settingsButtons').classList.remove('hidden');
            document.getElementById('setupTitle').textContent = '‚öôÔ∏è Settings';
            document.getElementById('setupError').classList.add('hidden');
            document.getElementById('setupSuccess').classList.add('hidden');
        }

        function closeSettings() {
            document.getElementById('setupSection').classList.add('hidden');
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all saved data and disconnect?')) {
                localStorage.clear();
                if (ws) {
                    ws.close();
                }
                location.reload();
            }
        }

        function updateForecastVisibility() {
            const hourlySection = document.querySelector('.hourly-section');
            const forecastSection = document.querySelector('.forecast-section');
            
            if (hourlySection && forecastSection) {
                if (showForecast) {
                    hourlySection.style.display = 'block';
                    forecastSection.style.display = 'block';
                } else {
                    hourlySection.style.display = 'none';
                    forecastSection.style.display = 'none';
                }
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function connectStation() {
            apiToken = document.getElementById('apiToken').value.trim();
            stationId = document.getElementById('stationId').value.trim();
            tempUnit = document.getElementById('tempUnit').value;
            keepScreenOn = document.getElementById('keepScreenOn').checked;
            showForecast = document.getElementById('showForecast').checked;

            if (!apiToken || !stationId) {
                showError('Please enter both API token and station ID');
                return;
            }

            localStorage.setItem('tempest_token', apiToken);
            localStorage.setItem('tempest_station', stationId);
            localStorage.setItem('tempest_temp_unit', tempUnit);
            localStorage.setItem('tempest_keep_screen_on', keepScreenOn);
            localStorage.setItem('tempest_show_forecast', showForecast);

            document.getElementById('setupError').classList.add('hidden');
            document.getElementById('setupSuccess').classList.add('hidden');
            
            updateForecastVisibility();
            fetchStationData();
        }

        async function fetchStationData() {
            try {
                // Fetch station metadata for location
                const stationResponse = await fetch(
                    `https://swd.weatherflow.com/swd/rest/stations/${stationId}?token=${apiToken}`
                );

                if (!stationResponse.ok) {
                    throw new Error('Failed to fetch station data. Check your credentials.');
                }

                stationData = await stationResponse.json();

                // Fetch current observations
                const obsResponse = await fetch(
                    `https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${apiToken}`
                );

                if (!obsResponse.ok) {
                    throw new Error('Failed to fetch observations.');
                }

                const obsData = await obsResponse.json();
                
                if (obsData.obs && obsData.obs.length > 0) {
                    updateDisplay(obsData.obs[0]);
                    
                    // Show success message if settings were open
                    if (!document.getElementById('setupSection').classList.contains('hidden')) {
                        document.getElementById('setupSuccess').textContent = 'Settings saved successfully!';
                        document.getElementById('setupSuccess').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('setupSection').classList.add('hidden');
                        }, 1500);
                    } else {
                        document.getElementById('setupSection').classList.add('hidden');
                    }
                    
                    document.getElementById('weatherSection').classList.remove('hidden');
                    
                    // Fetch forecast data
                    fetchForecast();
                    
                    // Connect WebSocket
                    connectWebSocket();
                }
            } catch (error) {
                showError(error.message);
            }
        }

        async function fetchForecast() {
            if (!stationData || !stationData.stations || stationData.stations.length === 0) return;

            const station = stationData.stations[0];
            const lat = station.latitude;
            const lon = station.longitude;

            try {
                const response = await fetch(
                    `https://swd.weatherflow.com/swd/rest/better_forecast?station_id=${stationId}&token=${apiToken}`
                );

                if (!response.ok) return;

                const forecast = await response.json();
                updateForecast(forecast);
            } catch (error) {
                console.error('Error fetching forecast:', error);
            }
        }

        function updateForecast(forecast) {
            if (!forecast || !forecast.forecast || !forecast.forecast.daily) return;

            const daily = forecast.forecast.daily;
            const hourly = forecast.forecast.hourly;

            // Update hourly forecast
            const hourlyContainer = document.getElementById('hourlyForecast');
            hourlyContainer.innerHTML = '';
            
            for (let i = 0; i < Math.min(12, hourly.length); i++) {
                const hour = hourly[i];
                const time = new Date(hour.time * 1000);
                const hourItem = document.createElement('div');
                hourItem.className = 'hour-item';
                hourItem.innerHTML = `
                    <div class="hour-time">${time.getHours() === 0 ? '12 AM' : time.getHours() > 12 ? (time.getHours() - 12) + ' PM' : time.getHours() + ' AM'}</div>
                    <div class="hour-icon">${getWeatherIcon(hour.icon)}</div>
                    <div class="hour-temp">${Math.round(parseFloat(convertTemp(hour.air_temperature)))}¬∞</div>
                `;
                hourlyContainer.appendChild(hourItem);
            }

            // Update daily forecast
            const weeklyContainer = document.getElementById('weeklyForecast');
            weeklyContainer.innerHTML = '';
            
            for (let i = 0; i < Math.min(7, daily.length); i++) {
                const day = daily[i];
                const date = new Date(day.day_start_local * 1000);
                const dayItem = document.createElement('div');
                dayItem.className = 'day-item';
                dayItem.innerHTML = `
                    <div class="day-name">${i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    <div class="day-icon">${getWeatherIcon(day.icon)}</div>
                    <div class="day-temps">${Math.round(parseFloat(convertTemp(day.air_temp_high)))}¬∞ / ${Math.round(parseFloat(convertTemp(day.air_temp_low)))}¬∞</div>
                `;
                weeklyContainer.appendChild(dayItem);
            }

            // Update sunrise/sunset
            if (daily[0]) {
                const sunrise = new Date(daily[0].sunrise * 1000);
                const sunset = new Date(daily[0].sunset * 1000);
                
                // Format sunrise
                const sunriseHours = sunrise.getHours();
                const sunriseMinutes = sunrise.getMinutes().toString().padStart(2, '0');
                const sunriseAmPm = sunriseHours >= 12 ? 'PM' : 'AM';
                const sunriseDisplay = ((sunriseHours + 11) % 12 + 1) + ':' + sunriseMinutes;
                
                // Format sunset
                const sunsetHours = sunset.getHours();
                const sunsetMinutes = sunset.getMinutes().toString().padStart(2, '0');
                const sunsetAmPm = sunsetHours >= 12 ? 'PM' : 'AM';
                const sunsetDisplay = ((sunsetHours + 11) % 12 + 1) + ':' + sunsetMinutes;
                
                document.getElementById('sunrise').textContent = sunriseDisplay;
                document.getElementById('sunset').textContent = sunsetDisplay;
            }
        }

        function getWeatherIcon(iconName) {
            const icons = {
                'clear-day': '‚òÄÔ∏è',
                'clear-night': 'üåô',
                'cloudy': '‚òÅÔ∏è',
                'foggy': 'üå´Ô∏è',
                'partly-cloudy-day': '‚õÖ',
                'partly-cloudy-night': '‚òÅÔ∏è',
                'possibly-rainy-day': 'üå¶Ô∏è',
                'possibly-rainy-night': 'üåßÔ∏è',
                'possibly-sleet-day': 'üå®Ô∏è',
                'possibly-sleet-night': 'üå®Ô∏è',
                'possibly-snow-day': 'üå®Ô∏è',
                'possibly-snow-night': 'üå®Ô∏è',
                'possibly-thunderstorm-day': '‚õàÔ∏è',
                'possibly-thunderstorm-night': '‚õàÔ∏è',
                'rainy': 'üåßÔ∏è',
                'sleet': 'üå®Ô∏è',
                'snow': '‚ùÑÔ∏è',
                'thunderstorm': '‚õàÔ∏è',
                'windy': 'üí®'
            };
            return icons[iconName] || 'üå§Ô∏è';
        }

        function connectWebSocket() {
            if (ws) ws.close();

            ws = new WebSocket('wss://ws.weatherflow.com/swd/data?token=' + apiToken);

            ws.onopen = () => {
                console.log('WebSocket connected');
                ws.send(JSON.stringify({
                    type: 'listen_start',
                    device_id: parseInt(stationId),
                    id: 'station-' + stationId
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'obs_st') {
                    updateDisplayFromWebSocket(data.obs[0]);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        function convertTemp(tempC) {
            if (tempUnit === 'C') {
                return tempC.toFixed(1);
            }
            return (tempC * 9/5 + 32).toFixed(1);
        }

        function getTempUnit() {
            return tempUnit === 'C' ? '¬∞C' : '¬∞F';
        }

        function updateDisplay(obs) {
            const temp = convertTemp(obs.air_temperature);
            const feelsLike = obs.feels_like ? convertTemp(obs.feels_like) : temp;
            
            document.getElementById('temperature').textContent = Math.round(parseFloat(temp));
            document.getElementById('feelsLike').textContent = Math.round(parseFloat(feelsLike));
            
            // Update the temperature unit display
            document.querySelectorAll('.temp-unit').forEach(el => {
                el.textContent = getTempUnit();
            });
            
            document.getElementById('humidity').textContent = Math.round(obs.relative_humidity);
            document.getElementById('windSpeed').textContent = (obs.wind_avg * 2.237).toFixed(1);
            document.getElementById('pressure').textContent = (obs.barometric_pressure * 0.02953).toFixed(2);
            document.getElementById('uv').textContent = obs.uv.toFixed(1);
            
            // Update weather icon based on conditions
            updateWeatherIcon(obs);
            updateLastUpdateTime();
        }

        function updateDisplayFromWebSocket(obs) {
            const temp = convertTemp(obs[7]);
            
            document.getElementById('temperature').textContent = Math.round(parseFloat(temp));
            document.getElementById('humidity').textContent = Math.round(obs[8]);
            document.getElementById('windSpeed').textContent = (obs[2] * 2.237).toFixed(1);
            document.getElementById('pressure').textContent = (obs[6] * 0.02953).toFixed(2);
            document.getElementById('uv').textContent = obs[12].toFixed(1);
            
            updateLastUpdateTime();
        }

        function updateWeatherIcon(obs) {
            let icon = 'üå§Ô∏è';
            
            if (obs.precip_type > 0) {
                icon = 'üåßÔ∏è';
            } else if (obs.solar_radiation > 800) {
                icon = '‚òÄÔ∏è';
            } else if (obs.solar_radiation > 400) {
                icon = '‚õÖ';
            } else if (obs.solar_radiation > 100) {
                icon = '‚òÅÔ∏è';
            } else {
                icon = 'üåô';
            }
            
            document.getElementById('weatherIcon').textContent = icon;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('setupError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

// Register the Service Worker for PWA functionality
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered!'))
            .catch(err => console.log('Service Worker failed:', err));
    });
}
    </script>
</body>
</html>
